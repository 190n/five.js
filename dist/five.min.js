// five.js library v0.1.1
// licensed under LGPL 3.0 license
// built 2015-08-17

"use strict";(function(a){this.module&&this.module.exports?module.exports=a:this.five=a}).call(this,function(a){var b={version:"0.1.1",canvasSupport:a?1:!!this.CanvasRenderingContext2D/2+!!this.TextMetrics/2};if(.5==b.canvasSupport&&console.warn("No canvas text support."),!b.canvasSupport)throw new Error("No canvas support.");return b.Circ=function(a,b){this.x=a.x,this.y=a.y,this.radius=b},b.Circ.prototype.boundingBox=function(){return new b.Rect(new b.Point(this.x-this.radius,this.y-this.radius),new b.Size(2*this.radius,2*this.radius))},b.collider={rectVsRect:function(a,b){return a.x<=b.x+b.w&&a.x+a.w>=b.x&&a.y<=b.y+b.h&&a.y+a.h>=b.y},circVsCirc:function(a,c){return new b.Point(a.x,a.y).distanceTo(new b.Point(c.x,c.y))<=a.radius+c.radius},rectVsPoint:function(a,b){return(b.x>a.x||b.x<a.x+a.w)&&(b.y>a.y||b.y<a.y+a.h)},circVsPoint:function(a,c){return new b.Point(a.x,a.y).distanceTo(c)<=a.radius}},b.Color=function(a,b,c,d){this.r=a,this.g=b,this.b=c,this.a="undefined"==typeof d?1:d},b.Color.prototype.toString=function(){return"rgba("+this.r+", "+this.g+", "+this.b+", "+this.a+")"},b.Delta=function(a,b){this.dx=a,this.dy=b},Object.defineProperty(b.Delta.prototype,"length",{get:function(){return Math.sqrt(Math.pow(this.dx,2)+Math.pow(this.dy,2))}}),Object.defineProperty(b.Delta.prototype,"vector",{get:function(){return new b.Vector(Math.atan2(this.dy,this.dx)*(180/Math.PI)+90,this.length)}}),b.Delta.prototype.add=function(a){return new b.Delta(this.dx+a.dx,this.dy+a.dy)},b.Emitter=function(){this._listeners={}},b.Emitter.prototype.on=function(a,b){this._listeners||(this._listeners={}),this._listeners[a]||(this._listeners[a]=[]),this._listeners[a].push(b)},b.Emitter.prototype.emit=function(a,b){this._listeners[a]&&this._listeners[a].forEach(function(a){"function"==typeof a&&a(b)},this)},b.Emitter.prototype.off=function(a,b){this._listeners[a]||(this._listeners[a]=[]),this._listeners[a]=this._listeners[a].filter(function(a){return a!=b})},b.Emitter.prototype.once=function(a,b){var c=function(d){b(d),this.off(a,c)}.bind(this);this.on(a,c)},b.Entity=function(a,c){this.game=a,this.x="undefined"==typeof c.location?0:c.location.x,this.y="undefined"==typeof c.location?0:c.location.y,this.size=c.size||c.tileSize,this.alpha="undefined"==typeof c.alpha?1:c.alpha,this.rotation=c.rotation||0,this.image=c.image,this.boundingBox="undefined"==typeof c.boundingBox?new b.Rect(new b.Point(this.x,this.y),this.size):new b.Rect(new b.Point(this.x+c.boundingBox.x,this.y+c.boundingBox.y),new b.Size(this.size.w+c.boundingBox.w,this.size.h+c.boundingBox.h)),c.delta?this.delta=c.delta:c.vector?this.vector=c.vector:this.delta=new b.Delta(0,0),this.sprite=a.sprite({image:this.image,tileSize:c.tileSize,size:this.size,location:new b.Point(this.x,this.y),alpha:this.alpha,rotation:this.rotation}),this.sprite.on("load",function(){this.emit("spawn")}.bind(this));for(var d in c.animations)this.sprite.addAnimation(d,c.animations[d]);this.dead=!1,this.alive=!0,this.killer=void 0,this.game.addEntity(this)},b.Entity.prototype=new b.Emitter,b.Entity.prototype.constructor=b.Entity,b.Entity.prototype._update=function(a){this.sprite.update(a);var b=this.vector?this.vector.delta:this.delta;this.x+=b.dx*(a/1e3),this.y+=b.dy*(a/1e3),this.sprite.x=this.x,this.sprite.y=this.y,this.sprite.opacity=this.opacity,this.sprite.rotation=this.rotation},b.Entity.prototype.draw=function(){this.sprite.draw()},b.Entity.prototype.play=function(a,b,c){this.sprite.play(a,b,c)},b.Entity.prototype._gameLoopHandler=function(a){"function"==typeof this.update&&this.update(a),this._update(a),this.draw()},b.Entity.prototype.kill=function(){this.dead=!0,this.alive=!1,this.emit("die",this.killer),"function"==typeof this.die&&this.die(),this.game.removeEntity(this)},b.Font=function(a,b){this.game=a,this.name=b},b.Font.prototype.draw=function(a){var b=this.game.ctx;b.save(),b.font=(a.style||"")+" "+(a.weight||"")+" "+(a.size||16)+"px "+this.name,b.textBaseline=a.baseline,b.textAlign=a.alignment,b.fillStyle="undefined"==typeof a.color?"#000000":a.color.toString(),b.fillText(a.text,a.location.x,a.location.y),b.restore()},b.Game=function(a){if(this.initTime=Date.now(),this.itemsLoaded=0,this.itemsToLoad=0,this.loaderInner=0,this.loaderOuter=0,this.loaded=!1,this.backlog=[],this.entities=[],this.updateEntities=!0,this.logger=new b.Logger(this,{debug:a.debug||!1,timestamp:a.debug||!1,color:a.fpsColor}),this.debug=a.debug||!1,this.debugKeysDown=!1,a.size||console.warn("No size specified. Defaulting to 640x480."),this.width=a.size.w||640,this.height=a.size.h||480,this.fps=a.fps||"auto","auto"!=this.fps&&(this.delay=1e3/this.fps),this.background="undefined"==typeof a.background?"#ffffff":a.background.toString(),this.loaderColor=a.loaderColor||new b.Color(0,128,255),this.canvas=a.target,!this.canvas)throw new Error("five.game requires a canvas to initialize.");this.canvas.width=this.width,this.canvas.height=this.height,this.ctx=this.canvas.getContext("2d"),this.stateMachine=new b.StateMachine(a.states,a.state),this.showFps=a.showFps||!1,this.fpsColor=a.fpsColor||new b.Color(80,80,80),this.fpsFont=this.font("monospace"),this.realFps=0,this.fpsGraph=[],this.mouse=new b.Mouse(this);for(var c=0;80>c;c++)this.fpsGraph.push(0);this.log("INIT"),this.log("size: "+this.width+"x"+this.height),this.log("debug: "+(a.debug?"on":"off")),this.on("load",function(){this.log("game loaded"),this.log(Date.now()-this.startTime+"ms after start() called"),this.log(Date.now()-this.initTime+"ms after game created")}.bind(this))},b.Game.prototype=new b.Emitter,b.Game.prototype.constructor=b.Game,b.Game.prototype._gameLoop=function(){var a=Date.now();if("auto"==this.fps?requestAnimationFrame(this._gameLoop.bind(this)):setTimeout(this._gameLoop.bind(this),this.delay),this.ctx.clearRect(0,0,this.width,this.height),this.ctx.fillStyle=this.background,this.ctx.fillRect(0,0,this.width,this.height),this.loaded){if(this.updateEntities&&this.entities.forEach(function(b){b._gameLoopHandler(a-this.lastUpdate)},this),this.stateMachine.run(a-this.lastUpdate),this.emit("gameLoop",{dt:a-this.lastUpdate}),this.showFps){this.fpsFont.draw({location:new b.Point(this.width,this.height),color:this.fpsColor,baseline:"bottom",alignment:"right",weight:"bold",size:16,text:this.realFps+" FPS"});var c=this.width-160;this.ctx.save(),this.ctx.fillStyle=new b.Color(1.5*this.fpsColor.r>255?255:1.5*this.fpsColor.r,1.5*this.fpsColor.g>255?255:1.5*this.fpsColor.g,1.5*this.fpsColor.b>255?255:1.5*this.fpsColor.b).toString(),this.ctx.beginPath(),this.fpsGraph.forEach(function(a,b){this.ctx.fillRect(c+b,this.height-a/80*48,1,a/80*48)},this),this.ctx.closePath(),this.ctx.restore()}}else{this.ctx.beginPath();var d=0===this.itemsToLoad?1:this.itemsLoaded/this.itemsToLoad;this.log("loading: "+Math.round(100*d)+"%"),1==d&&(this.emit("load"),this.loaded=!0),this.ctx.strokeStyle=this.loaderColor.toString();var e=(this.loaderInner+this.loaderOuter)/2,f=this.loaderOuter-this.loaderInner;this.ctx.lineWidth=f,this.ctx.arc(this.width/2,this.height/2,e,0,2*Math.PI),this.ctx.stroke();var g=a-this.lastUpdate;this.loaderOuter>=32?(this.loaderOuter+=.06*g,this.loaderInner+=.12*g):(this.loaderInner=0,this.loaderOuter+=.06*g),this.loaderInner>=this.loaderOuter&&(this.loaderInner=0,this.loaderOuter=0)}a-this.lastFpsUpdate>=250&&this.showFps&&(this.realFps=Math.round(1e3/(a-this.lastUpdate)),this.fpsGraph.push(this.realFps),this.fpsGraph.length>80&&(this.fpsGraph=this.fpsGraph.slice(-80)),this.lastFpsUpdate=a),this.debug&&this.logger.draw(),this.lastUpdate=a,b.keyboard.isDown("alt")&&b.keyboard.isDown("shift")&&b.keyboard.isDown("l")?this.debugKeysDown||(this.debug=!this.debug,this.debugKeysDown=!0,this.log("toggle debug")):this.debugKeysDown=!1},b.Game.prototype.start=function(){this.log("start game"),this.startTime=Date.now(),this.lastUpdate=Date.now(),this.lastFpsUpdate=Date.now(),this._gameLoop()},b.Game.prototype.log=function(a){return this.logger?(this.backlog.forEach(function(a){a.warning?this.logger.warn(a.message):this.logger.log(a.message)},this),this.backlog=[],void this.logger.log(a)):this.backlog.push({message:a,warning:!1})},b.Game.prototype.warn=function(a){return this.logger?(this.backlog.forEach(function(a){a.warning?this.logger.warn(a.message):this.logger.log(a.message)},this),this.backlog=[],void this.logger.warn(a)):this.backlog.push({message:a,warning:!0})},b.Game.prototype.flushLog=function(){this.logger.flush(),this.log("flush log")},b.Game.prototype.font=function(a){return this.log("font request: "+a),new b.Font(this,a)},b.Game.prototype.sprite=function(a){return this.log("sprite request: "+a.image),new b.Sprite(this,a)},b.Game.prototype.tilemap=function(a){return this.log("tilemap request: "+a.url),new b.Tilemap(this,a)},b.Game.prototype.image=function(a){return this.log("image request: "+a.image),new b.Image(this,a)},b.Game.prototype.itemLoaded=function(a){this.log("loaded asset: "+a),this.itemsLoaded++,this.itemsLoaded>=this.itemsToLoad&&!this.loaded&&(this.emit("load"),this.loaded=!0)},b.Game.prototype.changeState=function(a){this.log("change state: "+a),this.stateMachine.states[a]&&(this.emit("statechange",{old:this.stateMachine.state,"new":a}),this.stateMachine.state=a)},b.Game.prototype.addEntity=function(a){this.entities.push(a)},b.Game.prototype.removeEntity=function(a){this.entities=this.entities.filter(function(b){return a!=b})},b.Image=function(a,c){this.game=a,this.sheet=new b.SpriteSheet(a,{image:c.image}),this.sheet.on("load",function(){this.sheet.tileWidth=this.sheet.img.width,this.sheet.tileHeight=this.sheet.img.height,this.size=c.size}.bind(this)),this.location=c.location,this.rotation=c.rotation,this.alpha="undefined"==typeof c.alpha?1:c.alpha},b.Image.prototype.draw=function(a){this.sheet.draw({index:0,location:this.location||a.location,size:this.size,rotation:this.rotation||a.location,alpha:this.alpha})},b.keyboard=new b.Emitter,b.keyboard.map={65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",96:"0-numpad",97:"1-numpad",98:"2-numpad",99:"3-numpad",100:"4-numpad",101:"5-numpad",102:"6-numpad",103:"7-numpad",104:"8-numpad",105:"9-numpad",37:"left",38:"up",39:"right",40:"down",27:"escape",32:"space",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12"},b.keyboard.active=[],a||window.addEventListener("load",function(){document.body.onkeydown=function(a){var c=b.keyboard.map[a.keyCode];c&&(b.keyboard.active.push(c),b.keyboard.emit("down",{key:c}),b.keyboard.emit("down:"+c))},document.body.onkeyup=function(a){var c=b.keyboard.map[a.keyCode];c&&(b.keyboard.active=b.keyboard.active.filter(function(a){return a!=c}),b.keyboard.emit("up",{key:c}),b.keyboard.emit("up:"+c))},document.body.onkeypress=function(a){var c=b.keyboard.map[a.keyCode];c&&(b.keyboard.emit("press",{key:c}),b.keyboard.emit("press:"+c))}},!1),b.keyboard.isDown=function(a){return this.active.indexOf(a)>-1},b.Logger=function(a,c){this.game=a,this.debug=c.debug||!1,this.timestamp=c.timestamp||!1,this.font=a.font("monospace"),this.color=c.color||new b.Color(80,80,80),this.msgs=[]},b.Logger.prototype.log=function(a){this.timestamp&&(a="["+Date.now()+"] "+a);try{console.log(a)}catch(b){}this.debug&&(this.msgs.push({message:a,bold:!1}),this.msgs.length>20&&(this.msgs=this.msgs.slice(-20)))},b.Logger.prototype.warn=function(a){this.debug&&(a="warning: "+a),this.timestamp&&(a="["+Date.now()+"] "+a);try{console.warn(a)}catch(b){}this.debug&&(this.msgs.push({message:a,bold:!0}),this.msgs.length>20&&(this.msgs=this.msgs.slice(-20)))},b.Logger.prototype.draw=function(){var a=this.game.height-14*this.msgs.length;this.msgs.forEach(function(c,d){var e=14*d+a;this.font.draw({location:new b.Point(0,e),color:this.color,baseline:"top",alignment:"left",weight:c.bold?"bold":"normal",size:12,text:c.message})},this)},b.Logger.prototype.flush=function(){this.msgs=[]},b.Mouse=function(a){this.canvas=a.canvas,this.game=a,this.x=0,this.y=0,this.left=!1,this.middle=!1,this.right=!1,document.addEventListener("mousemove",function(a){this.x=a.clientX-a.target.offsetLeft,this.y=a.clientY-a.target.offsetTop}.bind(this)),this.canvas.addEventListener("mousedown",function(a){var b=a.button?1==a.button?"middle":"right":"left";this.emit("down",{button:b}),this.emit("down:"+b),this[b]=!0}.bind(this)),this.canvas.addEventListener("mouseup",function(a){var b=a.button?1==a.button?"middle":"right":"left";this.emit("up",{button:b}),this.emit("up:"+b),this.emit("click",{button:b}),this.emit("click:"+b),this[b]=!1}.bind(this))},b.Mouse.prototype=new b.Emitter,b.Mouse.prototype.constructor=b.Mouse,b.Point=function(a,b){this.x=a,this.y=b},b.Point.prototype.distanceTo=function(a){return this.delta(a).length},b.Point.prototype.delta=function(a){return new b.Delta(this.x-a.x,this.y-a.y)},b.Point.prototype.add=function(a){return a instanceof b.Vector&&(a=a.delta),new b.Point(this.x+a.dx,this.y+a.dy)},b.Point.prototype.toString=function(){return"("+this.x+", "+this.y+")"},a||(Array.prototype.forEach=Array.prototype.forEach||function(a,b){for(var c in this)a.call(b||window,this[c],c,this)},Array.prototype.filter=Array.prototype.filter||function(a,b){var c;for(var d in this)a.call(b||window,this[d],d,this)&&c.push(this[d]);return c},Function.prototype.bind=Function.prototype.bind||function(a){var b=this;return function(){b.apply(a,arguments)}},function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;c++)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}(),Object.create=Object.create||function(a){function b(){}return b.prototype=a,new b}),b.Rect=function(a,b){this.x=a.x,this.y=a.y,this.w=b.w,this.h=b.h},Object.defineProperty(b.Rect.prototype,"center",{get:function(){return new b.Point(this.x+this.w/2,this.y+this.h/2)}}),Object.defineProperty(b.Rect.prototype,"diagonal",{get:function(){return new b.Size(this.w,this.h).diagonal}}),Object.defineProperty(b.Rect.prototype,"corners",{get:function(){return[new b.Point(this.x,this.y),new b.Point(this.x+this.w,this.y),new b.Point(this.x+this.w,this.y+this.h),new b.Point(this.x,this.y+this.h)]}}),b.Size=function(a,b){this.w=a,this.h=b},Object.defineProperty(b.Size.prototype,"delta",{get:function(){return new b.Delta(this.w,this.h)}}),Object.defineProperty(b.Size.prototype,"diagonal",{get:function(){return this.delta.length}}),b.SpriteSheet=function(a,b){this.game=a,this.loaded=!1,this.game.itemsToLoad++,this.img=new Image,this.img.addEventListener("load",function(){this.game.itemLoaded(this),this.loaded=!0,this.emit("load")}.bind(this),!1),this.img.src=b.image,b.tileSize&&(this.tileWidth=b.tileSize.w,this.tileHeight=b.tileSize.h)},b.SpriteSheet.prototype=new b.Emitter,b.SpriteSheet.prototype.constructor=b.SpriteSheet,b.SpriteSheet.prototype.draw=function(a){if(this.loaded){var c=a.index*this.tileWidth,d=0,e=this.tileWidth,f=this.tileHeight,g=a.location.x,h=a.location.y,i=a.size||new b.Size(this.tileWidth,this.tileHeight);this.game.ctx.save(),this.game.ctx.translate(g+i.w/2,h+i.h/2),this.game.ctx.rotate(b.Vector.deg2rad(a.rotation||0)),this.game.ctx.translate(-(g+i.w/2),-(h+i.h/2)),this.game.ctx.globalAlpha="undefined"==typeof a.opacity?1:a.opacity,this.game.ctx.drawImage(this.img,c,d,e,f,g,h,i.w,i.h),this.game.ctx.restore()}},b.SpriteSheet.prototype.toString=function(){return this.img.src},b.Sprite=function(a,c){this.game=a,this.sheet=new b.SpriteSheet(a,{image:c.image,tileSize:c.tileSize,game:a}),this.sheet.on("load",function(){this.emit("load")}.bind(this)),this.x=c.location.x,this.y=c.location.y,this.index=c.index||0,this.animations={},this.animation=null,this.timer=0,this.counter=0,this.size=c.size,this.opacity="undefined"==typeof c.opacity?1:c.opacity,this.rotation=c.rotation||0,this.index=0},b.Sprite.prototype=new b.Emitter,b.Sprite.prototype.constructor=b.Sprite,b.Sprite.prototype.addAnimation=function(a,b){this.animations[a]=b},b.Sprite.prototype.play=function(a,b,c){this.animation={name:a,duration:b,iterations:c},this.counter=0},b.Sprite.prototype.update=function(a){if(null!==this.animation){var b=this.animations[this.animation.name],c=this.animation.duration,d=b[Math.floor(this.timer/c*b.length)];void 0===d&&(this.counter<this.animation.iterations||0===this.animation.iterations?(this.counter++,d=b[0],this.timer=0,this.emit("loop")):(d=b[b.length-1],this.emit("end"))),this.timer+=a,this.index=d}},b.Sprite.prototype.draw=function(){this.sheet.draw({location:new b.Point(this.x,this.y),index:this.index,size:this.size,opacity:this.opacity,rotation:this.rotation})},b.StateMachine=function(a,b){this.states=a,this.state=b},b.StateMachine.prototype.run=function(){this.states[this.state].apply(null,arguments)},b.Tilemap=function(a,c){a.itemsToLoad++,this.layers=[],this.prerender="undefined"==typeof c?!0:"undefined"==typeof c.prerender?!0:c.prerender,this.game=a,this.scaleFactor="undefined"==typeof c?1:c.scaleFactor||1,this.sheet={draw:function(){}},this.loaded=!1,this.url=c.url;var d=new XMLHttpRequest;d.open("GET",c.url,!0),d.onload=function(){var a=JSON.parse(d.responseText);this.width=a.width,this.height=a.height,this.fakeGame={itemsToLoad:0,itemLoaded:function(){},ctx:document.createElement("canvas").getContext("2d")},a.tilesets.forEach(function(a){this.sheet=new b.SpriteSheet(this.fakeGame,{image:a.image,tileSize:new b.Size(a.tilewidth,a.tileheight)})},this),a.layers.forEach(function(a){this.layers.push(a.data)},this),this.fakeGame.ctx.canvas.width=this.width*this.sheet.tileWidth*this.scaleFactor,this.fakeGame.ctx.canvas.height=this.height*this.sheet.tileHeight*this.scaleFactor,this.fakeGame.ctx.imageSmoothingEnabled="undefined"==typeof c.pixelate?!1:!c.pixelate,this.fakeGame.ctx.mozImageSmoothingEnabled="undefined"==typeof c.pixelate?!1:!c.pixelate,this.fakeGame.ctx.webkitImageSmoothingEnabled="undefined"==typeof c.pixelate?!1:!c.pixelate,this.fakeGame.ctx.msImageSmoothingEnabled="undefined"==typeof c.pixelate?!1:!c.pixelate,this.loaded=!0,this.sheet.on("load",function(){this.prerender&&this.render(),this.loaded=!0,this.game.itemLoaded(this.url)}.bind(this))}.bind(this),d.send()},b.Tilemap.prototype.render=function(a){a=a||new b.Point(0,0),this.prerender&&this.game.log("render map: "+this.url),this.layers.forEach(function(c){c.forEach(function(c,d){if(c){var e=d%this.width*this.sheet.tileWidth*this.scaleFactor,f=Math.floor(d/this.width)*this.sheet.tileHeight*this.scaleFactor;(this.prerender||!(e+a.x<=-this.sheet.tileWidth||e+a.x>=this.game.width||f+a.y<=-this.sheet.tileHeight||f+a.y>=this.game.height))&&this.sheet.draw({index:c-1,location:new b.Point(Math.round(e),Math.round(f)),size:new b.Size(this.sheet.tileWidth*this.scaleFactor,this.sheet.tileHeight*this.scaleFactor)})}},this)},this)},b.Tilemap.prototype.draw=function(a){this.prerender||this.render(a),this.loaded&&(a=a||new b.Point(0,0),this.game.ctx.drawImage(this.fakeGame.ctx.canvas,a.x,a.y))},b.Vector=function(a,b){this.dir=a,this.len=b},b.Vector.deg2rad=function(a){return a/(180/Math.PI)},Object.defineProperty(b.Vector.prototype,"delta",{get:function(){return new b.Delta(Math.round(Math.cos(b.Vector.deg2rad(this.dir-90))*this.len*100)/100,Math.round(Math.sin(b.Vector.deg2rad(this.dir-90))*this.len*100)/100)}}),b.Vector.prototype.add=function(a){var c=this.delta,d=a.delta;return new b.Delta(c.dx+d.dx,c.dy+d.dy).vector},b}.call(this,"undefined"==typeof this.window));